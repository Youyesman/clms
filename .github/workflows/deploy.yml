name: Deploy to Production (Non-Docker)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute remote ssh commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. 프로젝트 폴더로 이동 및 코드 최신화
            cd /home/clms
            git fetch origin
            git reset --hard origin/main

            # 2. 백엔드 설정 및 빌드 (venv, migrations, static 등)
            chmod +x deployment/*.sh
            ./deployment/setup_backend.sh

            # 3. 프론트엔드 빌드 (yarn install, yarn build 등)
            ./deployment/setup_frontend.sh

            # 4. 서비스 재시작
            # (Gunicorn 서비스 이름이 clms-backend인 경우)
            sudo systemctl restart clms-backend
            
            # 5. Apache 설정 파일이 바뀌었을 수 있으므로 다시 적용 및 리로드
            sudo cp /home/clms/deployment/clms.conf /etc/apache2/sites-available/
            sudo systemctl reload apache2

